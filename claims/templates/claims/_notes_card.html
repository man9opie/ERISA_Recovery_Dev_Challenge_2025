{# claims/templates/claims/_notes_card.html #}
{% load humanize tz %}

<div id="notes-card-{{ claim.pk }}"
     class="notes-card detail-card"
     x-data="{ showForm:false }"
     x-cloak
     @note-saved.window="showForm = false">

  <h4 class="section-title" style="margin:0 0 .75rem 0;">Notes &amp; Annotations</h4>

  <!-- 备注列表（仅这个容器会被 htmx 替换） -->
  <div id="notes-list-{{ claim.pk }}" class="notes-list"
       hx-on:htmx:afterSwap="$dispatch('note-saved')">
    {% include "claims/_notes_list.html" with claim=claim %}
  </div>

  <!-- ===== 按钮区（默认显示） ===== -->
  <div x-show="!showForm" style="margin-top:.75rem">
    <div class="quick-actions">

      <!-- Flag for Review（打开确认弹窗） -->
      <button class="qa-btn"
              hx-get="{% url 'claims:flag_confirm' claim.pk %}"
              hx-target="#modal"
              hx-swap="innerHTML">
        <span class="qa-icon" aria-hidden="true">
          <!-- flag icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
            <line x1="4" y1="22" x2="4" y2="15"/>
          </svg>
        </span>
        <span>Flag for Review</span>
      </button>

      <!-- Add Note（切换到表单） -->
      <button class="qa-btn" @click="showForm = true">
        <span class="qa-icon" aria-hidden="true">
          <!-- message-square icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a4 4 0 0 1-4 4H7l-4 4V5a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/>
          </svg>
        </span>
        <span>Add Note</span>
      </button>

      <!-- Generate Report（占位禁用） -->
      <button class="qa-btn" disabled>
        <span class="qa-icon" aria-hidden="true">
          <!-- file-text icon -->
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <line x1="10" y1="9"  x2="8" y2="9"/>
          </svg>
        </span>
        <span>Generate Report</span>
      </button>

    </div>
  </div>

  <!-- ===== Add Note 表单（出现时覆盖按钮区） ===== -->
  <form x-show="showForm"
        style="margin-top:.75rem"
        hx-post="{% url 'claims:add_note' claim.pk %}"
        hx-target="#notes-list-{{ claim.pk }}"
        hx-swap="innerHTML"
        hx-on:htmx:afterSwap="$el.reset(); showForm=false; $dispatch('note-saved');">

    {% csrf_token %}

    <label for="note-body-{{ claim.pk }}">Note</label>
    <textarea id="note-body-{{ claim.pk }}" name="body" rows="4"
              placeholder="Add a note..." required></textarea>

    <div style="display:flex; gap:.75rem; align-items:end; margin-top:.5rem;">
      <div style="flex:1">
        <label for="note-name-{{ claim.pk }}">Name</label>
        <input id="note-name-{{ claim.pk }}" name="author_name" placeholder="Your name" required>
      </div>

      <div style="display:flex; gap:.5rem;">
        <button type="button" class="secondary" @click="showForm=false">Cancel</button>
        <button type="submit" class="primary">Add Note</button>
      </div>
    </div>
  </form>
</div>
