<!doctype html>
<html lang="en" x-data="{ sidebarOpen: true }">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Claims Demo{% endblock %}</title>

  <!-- UI 基础 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <!-- 行为 -->
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>
  <script src="https://unpkg.com/alpinejs@3.x.x" defer></script>

  <style>
  /* =======================
     CSS Variables（统一调色/尺寸）
     ======================= */
  :root{
    /* 卡片与表格 */
    --card-radius: 12px;
    --card-border: #e6ebf1;
    --thead-bg: #f5f7fb;             /* 表头浅灰 */
    --table-max-h: 460px;            /* 表格可视最大高度 */

    /* Notes */
    --note-row-h: 5rem;
    --note-gap: .5rem;

    /* 间距 */
    --center-gap: 1.25rem;
  }

  /* =======================
     Utilities
     ======================= */
  [x-cloak]{ display:none !important; }

  .sr-only{
    position:absolute; width:1px; height:1px; padding:0; margin:-1px;
    overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }

  /* htmx 加载指示器 */
  .htmx-indicator{ display:none; opacity:0; transition:opacity .2s ease; }
  .htmx-request .htmx-indicator,
  .htmx-indicator.htmx-request{ display:inline-block; opacity:1; }

  /* =======================
     卡片：Detail / Table
     ======================= */
  .detail-layout{ display:grid; grid-template-columns:1.35fr 1fr; gap:1rem; }

  .detail-card,
  .table-card{
    border:1px solid var(--card-border);
    border-radius:var(--card-radius);
    background: var(--pico-background-color, #fff);
    box-shadow: 0 6px 20px rgba(16,24,40,.04), 0 1px 2px rgba(16,24,40,.06);
    overflow:hidden;
  }
  .detail-card{ padding:1rem 1.25rem; }

  .detail-card header{
    display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem;
  }
  .detail-title{ display:flex; align-items:center; gap:.5rem; font-weight:600; }

  /* =======================
     表格（含 sticky 表头）
     ======================= */
  .table-card .table-scroll{ max-height:var(--table-max-h); overflow:auto; }
  .table-card table{ border-collapse:separate; border-spacing:0; width:100%; }

  .table-card thead th{
    position:sticky; top:0; z-index:5;
    background:var(--thead-bg);
    box-shadow:0 1px 0 rgba(0,0,0,.06);
    white-space:nowrap;
  }
  .table-card thead th:first-child{ border-top-left-radius:var(--card-radius); }
  .table-card thead th:last-child { border-top-right-radius:var(--card-radius); }

  .claims-table td, .claims-table th{ vertical-align:middle; }
  .table-card tbody tr + tr td{ border-top:1px solid #f2f4f7; }
  .table-card tbody tr:hover{ background:#fafbff; }

  /* Actions 列右对齐 */
  .claims-table th.actions,
  .claims-table td.actions{ text-align:right !important; }

  /* 保险公司过长时省略号 */
  td.insurer span{
    display:inline-block; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  /* =======================
     组件：状态/金额/徽章
     ======================= */
  .money.pos{ color:#0a7a2f; font-weight:600; }
  .money.neg{ color:#b91c1c; font-weight:600; }

  .status-pill{
    display:inline-flex; align-items:center; white-space:nowrap;
    padding:.25rem .65rem; border-radius:999px; line-height:1;
    font-size:.8rem; border:1px solid transparent;
  }
  .status-pill.denied{ background:#fde2e1; color:#a41317; border-color:#f8cbc8; }
  .status-pill.paid{ background:#e8f6ec; color:#0a6d2b; border-color:#cfe9d7; }
  .status-pill.under_review{ background:#e8f0fe; color:#1a3fb0; border-color:#cfd9fb; }

  .badge{ padding:.1rem .4rem; border-radius:.4rem; font-size:.75rem; }
  .badge.denied{ background:#fde2e1; color:#a41317; }
  .badge.paid{ background:#e8f6ec; color:#0a6d2b; }
  .badge.under_review{ background:#e8f0fe; color:#1a3fb0; }

  /* =======================
     Detail 内容块
     ======================= */
  .detail-grid{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .stat{ text-align:center; }
  .stat .label{ font-size:.85rem; color:#6b7280; }
  .stat .value{ font-weight:700; font-size:1.25rem; }

  .chips{ display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.25rem; }
  .chip{ background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:.15rem .5rem; font-size:.8rem; }
  .denial-text{ color:#c1121f; }

  .center-line{
    display:flex; justify-content:center; align-items:center; gap:.5rem;
    flex-wrap:wrap; text-align:center; margin-top:.5rem;
  }
  .center-line .label{ font-size:.85rem; color:#6b7280; }
  .center-line .chips{ display:flex; gap:.4rem; flex-wrap:wrap; margin:0; }
  .center-line .chip{ background:#f1f5f9; border:1px solid #e2e8f0; border-radius:999px; padding:.15rem .5rem; font-size:.8rem; }
  .detail-card .center-line + .center-line{ margin-top:var(--center-gap) !important; }
  .detail-card .center-line + .stat{ margin-top:1.25rem !important; }
  .detail-card hr{ display:none !important; }

  /* =======================
     Notes（最多显示 3 条，超出滚动）
     ======================= */
  .notes-card #notes-list{
    max-height: calc(var(--note-row-h) * 3 + var(--note-gap) * 2) !important;
    overflow-y:auto !important; padding-right:.25rem; scrollbar-gutter:stable both-edges;
    -webkit-overflow-scrolling:touch;
  }
  .notes-card #notes-list ul{ list-style:none; margin:0; padding-left:0; }
  .notes-card #notes-list li{
    min-height:var(--note-row-h); padding:.5rem; margin-bottom:var(--note-gap);
    border:1px solid #eef1f4; border-radius:.5rem; background:#fff;
  }

  /* =======================
     顶部：搜索 + Filter
     ======================= */
  .filters-row{ display:grid; grid-template-columns:1fr auto; gap:.5rem; align-items:center; }

  .filter-wrap{ position:relative; }
  .btn-filter{
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.45rem .8rem; border-radius:.5rem; color:#374151; cursor:pointer;
    background: var(--pico-form-element-background-color);
    border: 1px solid var(--pico-form-element-border-color);
  }
  .btn-filter .dot{ width:.45rem; height:.45rem; border-radius:50%; background:#2563eb; }
  .btn-filter:hover, .btn-filter:focus{
    background: var(--pico-form-element-background-color);
    border-color: var(--pico-form-element-border-color);
    box-shadow: 0 0 0 3px rgba(0,0,0,.05);
  }

  .filter-panel{
    position:absolute; right:0; top:110%;
    width:280px; padding:.9rem; border:1px solid #e5e7eb; border-radius:.6rem;
    background:#fff; box-shadow:0 8px 24px rgba(0,0,0,.08); z-index:10;
  }
  .filter-panel fieldset{ margin:0 0 .6rem 0; padding:0; border:0; }
  .filter-panel legend{ font-weight:600; font-size:.9rem; margin-bottom:.25rem; }
  .filter-panel .radio{ display:block; margin:.25rem 0; }
  .panel-actions{ display:flex; justify-content:space-between; gap:.5rem; margin-top:.4rem; }
  .panel-actions .secondary{ background:#f8fafc; border:1px solid #e5e7eb; color:#374151; }
  .panel-actions .primary{ background:#2563eb; color:#fff; border:1px solid #1e40af; }

  /* =======================
     Actions（View + Flag）
     ======================= */
  .row-actions{ display:flex; align-items:center; justify-content:flex-end; gap:.5rem; }

  .btn-view{
    display:inline-flex; align-items:center; gap:.35rem; height:34px;
    padding:.35rem .6rem; border-radius:.5rem; cursor:pointer;
    background: var(--pico-form-element-background-color);
    border: 1px solid var(--pico-form-element-border-color);
    color:#374151;
  }
  .btn-view span{ font-size:.82rem; line-height:1; }
  .btn-view svg{ width:15px; height:15px; }
  .btn-view:hover{ box-shadow:0 1px 0 rgba(0,0,0,.05); }

  .flag-btn{
    background:transparent; border:none; width:34px; height:34px;
    display:grid; place-items:center; color:#e11d48; cursor:pointer; padding:0;
  }
  .flag-btn:hover{ color:#be123c; }
  .flag-btn.is-flagged{ color:#be123c; }
  .flag-btn svg{ display:block; }

  /* need_review=True 时的占位，防止 View 左右位移 */
  .flag-space{
    display:inline-block; width:34px; height:34px;
  }

  /* =======================
     分页交互
     ======================= */
  #pager a, .pager-nav a{ cursor:pointer !important; }
  #pager a:hover{ text-decoration:underline; }

  /* =======================
     Modal
     ======================= */
  #modal{ position:fixed; inset:0; z-index:1000; display:none; }
  #modal:not(:empty){ display:block; }
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
  }
  .modal-card{
    position:fixed; inset:auto; left:50%; top:50%;
    transform:translate(-50%,-50%);
    width:360px; max-width:calc(100% - 2rem);
    background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.15); padding:1rem;
  }
  </style>
</head>

<body hx-on:close-modal="document.getElementById('modal').innerHTML=''">
  <main class="container">
    {% block content %}{% endblock %}
  </main>

  <!-- 模态容器：用于装载确认框 -->
  <div id="modal"></div>

  <!-- 仅对红旗确认请求保留滚动位置，避免页面回到顶部 -->
  <script>
(function () {
  // ⚠️ 如果你的表格滚动容器 id 不是 "claims-table"，这里改成实际 id
  const getScrollBox = () => document.getElementById('claims-table');

  let lastWinScroll = 0;
  let lastBoxScroll = null;

  // 仅对“红旗确认”的请求记录滚动位置
  document.addEventListener('htmx:beforeRequest', function (ev) {
    const detail = ev.detail || {};
    const target = detail.target;      // 将被 swap 的目标（我们设为 #flag-btn-<id>）
    if (!target || !target.id || !target.id.startsWith('flag-btn-')) return;

    const box = getScrollBox();
    lastBoxScroll = box ? box.scrollTop : null;
    lastWinScroll = window.pageYOffset || document.documentElement.scrollTop || 0;

    // 给目标打个标记，方便 afterSettle 恢复时识别
    target.dataset._restoreScroll = '1';
  });

  // 等“所有动画/渲染都稳定后”再恢复（afterSettle 比 afterSwap 更晚）
  document.addEventListener('htmx:afterSettle', function (ev) {
    const detail = ev.detail || {};
    const target = detail.target;
    if (!target || target.dataset._restoreScroll !== '1') return;

    const box = getScrollBox();

    // 双 RAF：确保 DOM 完全稳定（包括你关闭 modal 的动作）
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (box != null && lastBoxScroll != null) {
          box.scrollTop = lastBoxScroll;
        }
        // 有些浏览器不认 'instant'，这里退回 auto
        try {
          window.scrollTo({ top: lastWinScroll, left: 0, behavior: 'auto' });
        } catch (e) {
          window.scrollTo(0, lastWinScroll);
        }
        // 清理
        delete target.dataset._restoreScroll;
      });
    });
  });

  // 兜底：后端 HX-Trigger 发出的 close-modal 事件，确保能关弹窗
  document.body.addEventListener('close-modal', function () {
    const modal = document.getElementById('modal');
    if (modal) modal.innerHTML = '';
  });
})();
</script>

</body>
</html>
